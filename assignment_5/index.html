<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Visualization - Final Group Project</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    type='text/css' />
    <link rel="stylesheet" type="text/css" href="css/style.css" />

    <!-- libraries -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css" rel="stylesheet" />
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css'
        <!-- separate files -->
    <script src="js/side_controls.js"></script>
    <script src="js/piechart.js"></script>

</head>

<body>
    <!-- Side controls -->
    <div id="leftControls" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeLeftControls()">&times;</a>
        <!-- Content of side controls -->
        <!-- <p style="color:white;">Custom range slider:</p>
        <input type="range" min="1" max="100" value="50" class="slider" id="slider_1">
        <script>
            var slider = document.getElementById("slider_1");
            slider.oninput = function () {
                slider.innerHTML = this.value;
                console.log(this.value);
            }
            openLeftControls();
        </script> -->
        <!-- <p style="color:white;">Visible activities:</p> -->
        <a>Visible activites:</a>
        üöó In vehicle:
        <input style="color:white;" type="checkbox" id="vehicleCheck" onclick="checkBoxes()" checked>
        <br>
        ü¶∂ On foot:
        <input style="color:white;" type="checkbox" id="onFootCheck" onclick="checkBoxes()" checked>
        <br>
        üö´ Not available:
        <input style="color:white;" type="checkbox" id="naCheck" onclick="checkBoxes()" checked>
        <br>
        üö¥ On bike:
        <input style="color:white;" type="checkbox" id="onBicycleCheck" onclick="checkBoxes()" checked>
        <br>
        üòë Still:
        <input style="color:white;" type="checkbox" id="stillCheck" onclick="checkBoxes()" checked>
        <br>
        ü§£ Tilting:
        <input style="color:white;" type="checkbox" id="tiltingCheck" onclick="checkBoxes()" checked>
        <br>
        ‚ùì Unknown:
        <input style="color:white;" type="checkbox" id="unknownCheck" onclick="checkBoxes()" checked>

    </div>
    <!-- Side Visualization -->
    <div id="rightControls" class="sidenav sidenavRight">
        <a style="left:0" href="javascript:void(0)" class="closebtn" onclick="closeRightControls()">&times;</a>
        <a>Side Controls</a>
        <!-- Content of side controls -->
        <div id="piechart"></div>

    </div>
    <div id="main">
        <span style="font-size:30px;cursor:pointer;position:fixed;top:50%" onclick="openLeftControls()" id="leftSideButton">&#9776;</span>
        <span style="font-size:30px;cursor:pointer;position:fixed;right:6px;top:50%" onclick="openRightControls()" id="rightSideButton">&#9776;</span>
    </div>
    <div id="map"></div>
    <script>
        mapboxgl.accessToken =
            'pk.eyJ1IjoiZGplcm5hZXMiLCJhIjoiY2pxbWRsMzEzMjFjaTQzcXN0MDc0Y2xrZiJ9.-LM9uIeDM1DqFF75g9KKwQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/basic-v9',
            center: [12.568337, 55.676098],
            zoom: 11
        });

        var heatmap = {
            id: 'place-heat',
            type: 'heatmap',
            source: 'placeringer',
            maxzoom: 15,
            paint: {
                "heatmap-opacity": 1,
                'heatmap-radius': {
                    stops: [
                        [11, 3],
                        [15, 5]
                    ]
                },
                'heatmap-intensity': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0,
                    1,
                    9,
                    3
                ],

                // assign color values be applied to points depending on their density
                'heatmap-color': [
                    'interpolate',
                    ['linear'],
                    ['heatmap-density'],
                    0,
                    'rgba(33,102,172,0)',
                    0.2,
                    'rgb(103,169,207)',
                    0.4,
                    'rgb(209,229,240)',
                    0.6,
                    'rgb(253,219,199)',
                    0.8,
                    'rgb(239,138,98)',
                    1,
                    'rgb(178,24,43)'
                ]
            }
        }

        var points = {
            id: 'place-point',
            type: 'circle',
            source: 'placeringer',
            maxzoom: 15,
            'paint': {
                'circle-opacity': 0,
                'circle-radius': {
                    'base': 1.75,
                    'stops': [
                        [12, 2],
                        [22, 180]
                    ]
                }
            }
        }

        map.on('load', function () {
            map.addSource('placeringer', {
                type: 'geojson',
                data: 'data/placeringsoversigt_small.geojson'
            });
            map.addLayer(heatmap);
            map.addLayer(points);
        });

        map.on('click', function () {
            openRightControls();

            // var layer = map.getSource('placeringer');


            //TESTING
            var query = map.queryRenderedFeatures({
                layers: ['place-point']
            });
            // var data = [10, 20, 100];
            var data = getCounts(query);
            createPieChart(data);
        })

        // Add drawing stuff for selecting
        var draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true
            }
        });
        map.addControl(draw);
        map.on('draw.create', updateArea);
        map.on('draw.delete', updateArea);
        map.on('draw.update', updateArea);

        function updateArea(e) {
            var query = map.queryRenderedFeatures({
                layers: ['place-point']
            })

            var userPolygon = e.features[0];
            // generate bounding box from polygon the user drew
            var polygonBoundingBox = turf.bbox(userPolygon);

            var southWest = [polygonBoundingBox[0], polygonBoundingBox[1]];
            var northEast = [polygonBoundingBox[2], polygonBoundingBox[3]];
            var northEastPointPixel = map.project(northEast);
            var southWestPointPixel = map.project(southWest);
            var features = map.queryRenderedFeatures([southWestPointPixel, northEastPointPixel], {
                layers: ['place-point']
            });
            var filtered = features.reduce(function (memo, feature) {
                if (!(undefined === turf.intersect(feature, userPolygon))) {
                    // only add the property, if the feature intersects with the polygon drawn by the user
                    // memo.push(feature.properties.FIPS);
                    memo.push(feature);
                }
                return memo;
            }, []);
            var data = getCounts(filtered);
            createPieChart(data);
        }

        function getCounts(data) {
            var counts = {};
            for (var i = 0; i < data.length; i++) {
                var activity = data[i].properties.activity;
                var val = 1 + (counts[activity] || 0);
                counts[activity] = val;
            }

            var object = []
            for (var property in counts) {
                object.push({
                    name: property,
                    value: counts[property]
                })
            }
            return object;
        }
    </script>

    <script>
        function checkBoxes() {
            var boxes = [
                ["vehicleCheck", "IN_VEHICLE"],
                ["onFootCheck", "ON_FOOT"],
                ["naCheck", "NA"],
                ["onBicycleCheck", "ON_BICYCLE"],
                ["stillCheck", "STILL"],
                ["tiltingCheck", "TILTING"],
                ["unknownCheck", "UNKNOWN"],
            ];

            var filteredActivities = []

            boxes.forEach(function (element) {
                var checkBox = document.getElementById(element[0]);
                if (checkBox.checked == true) {
                    filteredActivities.push(element[1])
                }
            });
            map.setFilter('place-heat', buildFilter(filteredActivities))
            map.setFilter('place-point', buildFilter(filteredActivities))
        }

        function buildFilter(arr) {
            var filter = ['in', 'activity'];
            if (arr.length === 0) {
                return filter;
            }
            for (var i = 0; i < arr.length; i += 1) {
                filter.push(arr[i]);
            }
            return filter;
        }

        var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        map.on('mouseenter', 'place-point', function (e) {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';

            let activities = {
                'IN_VEHICLE': 'In car üöó',
                'ON_FOOT': 'On foot ü¶∂',
                'NA': 'Not available üö´',
                'ON_BICYCLE': 'On bike üö¥',
                'STILL': 'Still üòë',
                'TILTING': 'Tilting ü§£',
                'UNKNOWN': 'Unknown ‚ùì'
            }

            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.date + "<br>" + activities[e.features[0].properties.activity];

            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            popup.setLngLat(coordinates)
                .setHTML(description)
                .addTo(map);
        });

        map.on('mouseleave', 'place-point', function () {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });
    </script>
</body>

</html>